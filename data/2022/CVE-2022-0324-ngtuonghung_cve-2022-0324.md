## CVE-2022-0324 - SONiC (Software for Open Networking in the Cloud) - dhcp6relay 堆栈溢出 (Stack-based Buffer Overflow)

**漏洞编号:** CVE-2022-0324

**漏洞类型:** 堆栈溢出 (Stack-based Buffer Overflow)

**影响应用:** SONiC (Software for Open Networking in the Cloud) - dhcp6relay

**危害等级:** 严重 (Critical)

**CVSS评分:** 9.8

**影响版本:** SONiC-swss-common 版本在提交 bcf5388 之前的版本，特别是 dhcp6relay 模块。

**利用条件:** 攻击者需要能够通过网络向运行 dhcp6relay 的设备发送精心构造的 DHCPv6 RELAY-REPL 报文。

**POC 可用性:** 9/10

**POC 类型:** 完整利用

**攻击复杂度:** 低

**投毒风险:** 5%

## 详情

POC有效性分析：本漏洞存在于 SONiC 网络操作系统的 dhcp6relay 模块中。通过分析提供的 POC 代码和 Dockerfile，可以看出这是一个非常完整的漏洞重现环境。Dockerfile 指明了漏洞存在于 sonic-buildimage 的 bcf5388 提交版本中，并详细描述了编译 sonic-swss-common 和 dhcp6relay 的过程。核心漏洞触发点位于处理 DHCPv6 选项的逻辑中。exploit.py 脚本构造了一个特殊的 DHCPv6_MESSAGE_TYPE_RELAY_REPL 消息。该消息包含一个 OPTION_RELAY_MSG (Option 9)，其长度字段被设置为 2^16 - 1 (65535)，而实际填充的数据 payload 为 2^15 字节。这种长度不匹配通常会导致程序在处理缓冲区拷贝时发生溢出。由于 dhcp6relay 在解析嵌套的 DHCPv6 选项时未能正确校验 option_length 字段，导致拷贝数据超过了预分配的栈空间。该 POC 脚本直接向目标 UDP 547 端口发送该 payload，逻辑清晰且针对性强，能够有效导致 dhcp6relay 进程崩溃（DoS）或在特定环境下实现远程代码执行（RCE）。利用步骤：1. 使用提供的 Dockerfile 构建实验环境，该环境会自动安装依赖、克隆特定版本的源码并编译受影响的组件。2. 运行 add_ipv6_addresses.sh 脚本，配置 Redis 数据库（SONiC 使用 Redis 管理配置）以及虚拟网卡和 IPv6 地址。3. 启动编译好的 dhcp6relay 进程。4. 运行 exploit.py 脚本，脚本会构造并发送一个畸形的 DHCPv6 RELAY-REPL 数据包到目标 IP 的 547 端口。5. 观察 dhcp6relay 进程，若发生 Segfault 崩溃则证明漏洞存在。 投毒风险分析：该 POC 仓库的投毒风险极低，评估约为 5%。首先，从代码结构来看，Dockerfile 所有的操作都是透明的，包括基础镜像的选择 (Ubuntu 20.04)、依赖包的安装 (apt install) 以及从官方 GitHub 仓库 (sonic-net/sonic-buildimage) 克隆代码。其构建过程遵循标准的开源软件编译流程，没有任何隐藏的二进制执行文件下载或可疑的外部域名连接。其次，exploit.py 脚本使用了 Python 原生的 socket 和 struct 库进行原始字节流的构造，代码量极少且逻辑完全公开。脚本中定义的变量如 UDP_IP 和 UDP_PORT 仅针对本地或指定的实验环境，不具备蠕虫传播属性。add_ipv6_addresses.sh 脚本也仅是对系统网络接口和本地 Redis 的常规配置。整个项目中没有发现任何经过混淆 (Obfuscation) 的代码段，也没有发现诸如 base64 解密执行、反弹 Shell 等恶意后门行为。唯一需要注意的是 Dockerfile 涉及大量的系统级库安装和源码编译，这在防御性研究中是标准的漏洞复现流程，不应被视为投毒。该 POC 属于高质量且诚实的漏洞研究成果，旨在帮助研究人员理解漏洞原理并验证补丁效果。

**项目地址:** [https://github.com/ngtuonghung/cve-reproduction/tree/main/cve-2022-0324](https://www.google.com/search?q=https://github.com/ngtuonghung/cve-reproduction/tree/main/cve-2022-0324)

**漏洞详情:** [https://nvd.nist.gov/vuln/detail/CVE-2022-0324](https://nvd.nist.gov/vuln/detail/CVE-2022-0324)
